<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Ask AI — Browser-Only</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Bootstrap 5 (CSS) via public CDN -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  <style>
    :root { font-family: system-ui, Arial, sans-serif; }
    body { margin: 0; padding: 24px; background:#0b1020; color:#e8eefc; }
    .wrap { max-width: 840px; margin: 0 auto; }
    h1 { margin: 0 0 12px; font-size: 1.25rem; opacity:.9 }
    form { display:flex; gap:8px; margin: 12px 0 16px; }
    input[type="text"] { flex:1; padding:12px; border-radius:12px; border:1px solid #2a3358; background:#0f1733; color:#e8eefc; }
    button { padding:12px 16px; border-radius:12px; border:0; background:#5b8cff; color:#0b1020; font-weight:700; cursor:pointer; }
    .status { font-size:.9rem; opacity:.8; margin: 6px 0 12px; }
    .card { background:#0f1733; border:1px solid #2a3358; border-radius:16px; padding:16px; }
    .answer { white-space: pre-wrap; line-height:1.45 }
    .spinner { display:inline-block; width:1em; height:1em; border:.18em solid #5b8cff; border-top-color:transparent; border-radius:50%; animation:spin 1s linear infinite; vertical-align:-.2em }
    @keyframes spin { to { transform:rotate(360deg) } }
    .small { font-size:.85rem; opacity:.75 }
    .muted { opacity:.7 }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-md navbar-dark" style="background:rgba(0,0,0,.25)">
    <div class="container">
      <a class="navbar-brand fw-bold" href="#">ADCOX.AI</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div id="nav" class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto">
			<li class="nav-item"><a class="nav-link" href="#about">About</a></li>
			<li class="nav-item"><a class="nav-link" href="#resume">Résumé</a></li>
			<li class="nav-item"><a class="nav-link" href="#work">Adventures</a></li>
			<li class="nav-item"><a class="nav-link" href="#weekly">Weekly</a></li>
			<li class="nav-item"><a class="nav-link" href="#contact">Contact</a></li>
			<li class="nav-item ms-2">
				<a class="btn btn-primary btn-sm" href="/ask-ai/">Ask AI</a>
			</li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="wrap">
    <h1>Ask AI</h1>
    <div class="small muted">Runs fully in your browser using a tiny open model. First load may take a bit while the model downloads and caches.</div>

    <form id="ask-form">
      <input id="q" type="text" placeholder="Ask a question…" autocomplete="off" />
      <button id="submit" type="submit">Ask</button>
    </form>

    <div class="status" id="status">Loading model… <span class="spinner"></span></div>

    <div class="card">
      <div class="answer" id="answer">Ask something to get started.</div>
    </div>
  </div>

  <!-- WebLLM via unpkg -->
  <script src="https://unpkg.com/@mlc-ai/web-llm/dist/webllm.min.js"></script>
  <script>
	  const statusEl = document.getElementById('status');
	  const answerEl = document.getElementById('answer');
	  const form = document.getElementById('ask-form');
	  const input = document.getElementById('q');
	  const submitBtn = document.getElementById('submit');

	  // Your Cloudflare Worker endpoint
	  const ENDPOINT = "https://ask-ai.adcox.workers.dev";

	  form.addEventListener('submit', async (e) => {
		e.preventDefault();
		const q = input.value.trim();
		if (!q) return;

		submitBtn.disabled = true;
		input.disabled = true;
		answerEl.textContent = "";
		statusEl.innerHTML = `Thinking… <span class="spinner"></span>`;

		try {
		  const resp = await fetch(ENDPOINT, {
			method: "POST",
			headers: { "content-type": "application/json" },
			body: JSON.stringify({ q })
		  });

		  if (!resp.ok || !resp.body) {
			statusEl.textContent = `Error: ${resp.status} ${resp.statusText}`;
			submitBtn.disabled = false;
			input.disabled = false;
			return;
		  }

		  // Stream Server-Sent Events from Worker
		  const reader = resp.body.getReader();
		  const decoder = new TextDecoder();
		  let buffer = "";

		  while (true) {
			const { value, done } = await reader.read();
			if (done) break;
			buffer += decoder.decode(value, { stream: true });

			// SSE frames are separated by \n\n
			let idx;
			while ((idx = buffer.indexOf("\n\n")) !== -1) {
			  const frame = buffer.slice(0, idx).trim();
			  buffer = buffer.slice(idx + 2);
			  if (frame.startsWith("data:")) {
				const payload = frame.slice(5).trim();
				if (payload === "[DONE]") continue;

				try {
				  const json = JSON.parse(payload);
				  const delta = json?.response ?? json?.choices?.[0]?.delta?.content ?? "";
				  if (delta) answerEl.textContent += delta;
				} catch {
				  // If Worker streams plain text, append as-is
				  answerEl.textContent += payload;
				}
			  }
			}
		  }

		  statusEl.textContent = "Done.";
		} catch (err) {
		  console.error(err);
		  statusEl.textContent = "Network error.";
		} finally {
		  submitBtn.disabled = false;
		  input.disabled = false;
		  input.select();
		}
	  });
	</script>
</body>
</html>